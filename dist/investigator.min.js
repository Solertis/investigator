function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("transceiver"),require("blessed"),require("dateformat"),require("json-prune"),require("shortid")):"function"==typeof define&&define.amd?define(["transceiver","blessed","dateformat","json-prune","shortid"],t):e.investigator=t(e.transceiver,e.blessed,e.dateFormat,e.prune,e.shortid)}(this,function(e,t,n,s,r){"use strict";function i(e){if(!(this instanceof l))return new i(e);e=e||{},e.bold=!0;var n=this;this.options=e,this.data={},this.nodeLines=[],this.lineNbr=0,h.call(this,e),e.extended=e.extended||!1,e.keys=e.keys||["space","enter"],e.template=e.template||{},e.template.extend=e.template.extend||" [+]",e.template.retract=e.template.retract||" [-]",e.template.lines=e.template.lines||!1,this.rows=t.list({height:0,top:1,width:0,left:1,selectedFg:"black",selectedBg:"white",keys:!0,tags:!0}),this.rows.key(e.keys,function(){n.nodeLines[this.getItemIndex(this.selected)].extended=!n.nodeLines[this.getItemIndex(this.selected)].extended,n.setData(n.data),n.screen.render(),n.emit("select",n.nodeLines[this.getItemIndex(this.selected)])}),this.append(this.rows)}var a=function(){function n(){var s=this;_classCallCheck(this,n),this.selectedLog=null,this.logs={},this.logsCount=0,this.channel=e.channel("log"),this.autoScroll=!0,this.element=t.list({top:"0",left:"0",bottom:7,tags:!0,keys:!0,mouse:!0,style:{selected:{fg:"black",bg:"white"}}}),this.element.key(["up","down","s","b"],function(e,t){"s"===t.name?s.autoScroll=!s.autoScroll:"b"===t.name?s.scrollToBottom():s.autoScroll=!1}),this.element.on("select item",function(e,t){s.selectedLog=s.getLogFromElement(e),s.selectedLog&&s.channel.emit("select log",s.selectedLog)}),this.channel.reply({addLog:this.addLog,getSelectedLog:this.getSelectedLog},this)}return _createClass(n,[{key:"addLog",value:function(e){var t=void 0;if(this.logs[e.id]=e,this.logsCount++,e.parent){var n=this.element.getItemIndex(e.parent.element)+e.parent.getChildren().length;this.element.insertItem(n,e.render()),t=this.element.getItem(n)}else t=this.element.add(e.render());return t.logId=e.id,this.autoScroll&&this.scrollToBottom(),1===this.logsCount&&this.channel.emit("select log",e),t}},{key:"getSelectedLog",value:function(){return this.selectedLog}},{key:"scrollToBottom",value:function(){this.element.move(this.logsCount)}},{key:"getLogFromElement",value:function(e){return this.logs[e.logId]}},{key:"focus",value:function(){this.element.focus()}}]),n}(),o=function(){function s(){_classCallCheck(this,s),this.channel=e.channel("log"),this.element=t.box({height:6,left:"0",bottom:0,tags:!0,keys:!0,padding:{left:1,right:1},style:{selected:{fg:"black",bg:"white",border:{fg:"white"},hover:{bg:"green"}}}}),this.channel.on("select log",this.updateLogDetails.bind(this))}return _createClass(s,[{key:"updateLogDetails",value:function(e){this.element.setContent(this.renderType(e)+this.renderId(e)+this.renderDate(e)+this.renderDuration(e)+this.renderData(e))}},{key:"renderType",value:function(e){if("root"===e.type)return"{magenta-fg}{bold}ROOT{/bold}{/magenta-fg}\n";if("success"===e.type)return"{green-fg}✔ {bold}SUCCESS{/bold}{/green-fg}\n";if("error"===e.type)return"{red-fg}✘ {bold}ERROR{/bold}{/red-fg}\n";if("warn"===e.type)return"{yellow-fg}! {bold}WARN{/bold}{/red-fg}\n";if("child"===e.type)return"{grey-fg}{bold}CHILD{/bold}{/grey-fg}\n";if("async"===e.type){if("resolved"===e.status)return"{bold}{green-fg}ASYNC CHILD{/bold} (RESOLVED ✔){/green-fg}\n";if("rejected"===e.status)return"{bold}{red-fg}ASYNC CHILD{/bold} (REJECTED ✘){/red-fg}\n";if("pending"===e.status)return"{cyan-fg}{bold}ASYNC CHILD{/bold} (PENDING ⌛){/cyan-fg}\n"}return"info"===e.type?"{white-fg}{bold}INFO{/bold}{/white-fg}\n":""}},{key:"renderId",value:function(e){return"{bold}ID:{/bold} {underline}"+e.id+"{/underline}\n"}},{key:"renderDate",value:function(e){return"{bold}TIME:{/bold} {magenta-fg}"+n(e.date,"dddd, mmmm dS yyyy, HH:MM:ss.L")+"{/magenta-fg}\n"}},{key:"renderDuration",value:function(e){return e.relativeDuration&&e.previousLog?"{bold}DURATION:{/bold} {yellow-fg}"+e.relativeDuration+"{/yellow-fg} (from {underline}"+e.previousLog.id+"{/underline})\n":""}},{key:"renderData",value:function(e){return e.data?"{bold}DATA:{/bold} "+e.renderData()+"\n":""}}]),s}(),l=t.Node,h=t.Box;i.prototype.walk=function(e,t){var n=[];if(e.parent||(e.parent=null),""==t&&e.name&&(this.lineNbr=0,this.nodeLines[this.lineNbr++]=e,n.push(e.name),t=" "),e.depth=t.length-1,e.children&&e.extended){var s=0;"function"==typeof e.children&&(e.childrenContent=e.children(e)),e.childrenContent||(e.childrenContent=e.children);for(var r in e.childrenContent){e.childrenContent[r].name||(e.childrenContent[r].name=r);r=e.childrenContent[r],r.parent=e,r.position=s++,"undefined"==typeof r.extended&&(r.extended=this.options.extended),"function"==typeof r.children?r.childrenContent=r.children(r):r.childrenContent=r.children;var i,a=r.position==Object.keys(r.parent.childrenContent).length-1,o="";i=a?"└":"├",r.childrenContent&&0!=Object.keys(r.childrenContent).length?r.extended?(i+="┬",o=this.options.template.retract):(i+="─",o=this.options.template.extend):i+="─",this.options.template.lines||(i="|-"),n.push(t+i+r.name+o),this.nodeLines[this.lineNbr++]=r;var l;l=a||!this.options.template.lines?t+" ":t+"│",n=n.concat(this.walk(r,l))}}return n},i.prototype.focus=function(){this.rows.focus()},i.prototype.render=function(){this.screen.focused==this.rows&&this.rows.focus(),this.rows.width=this.width-3,this.rows.height=this.height-3,h.prototype.render.call(this)},i.prototype.setData=function(e){var t=[];t=this.walk(e,""),this.data=e,this.rows.setItems(t)},i.prototype.__proto__=h.prototype,i.prototype.type="tree";var c=i,d=7,u=function(){function t(){_classCallCheck(this,t),this.channel=e.channel("log"),this.element=c({top:"center",left:"center",width:"90%",height:"75%",hidden:!0,label:"Inspecter",tags:!0,border:{type:"line"},style:{fg:"white",border:{fg:"#f0f0f0"}},template:{extend:"{bold}{green-fg} [+]{/}",retract:"{bold}{yellow-fg} [-]{/}",lines:!0}})}return _createClass(t,[{key:"open",value:function(e){e&&e.data&&(this.opened=!0,this.element.show(),this.element.focus(),this.element.setData(this.formatData(JSON.parse(s(e.data,d)))))}},{key:"close",value:function(){this.opened=!1,this.element.hide()}},{key:"formatData",value:function(e,t){var n=this,s=arguments.length<=2||void 0===arguments[2]?0:arguments[2];if(s++,"object"==typeof e&&null!==e){var r=function(){var r=Array.isArray(e)?"[Array]":"[Object]",i=t?t+" ":"",a={children:{},name:"{blue-fg}{bold}"+i+"{/bold}"+r+"{/blue-fg}",extended:3>s};return Object.keys(e).forEach(function(t){var r=n.formatData(e[t],t,s);r&&(a.children[t]=r)}),{v:a}}();if("object"==typeof r)return r.v}return"function"==typeof e?{name:"{blue-fg}"+t+"{/blue-fg}: {red-fg}{bold}[Function]{/}"}:"number"==typeof e?{name:"{blue-fg}"+t+"{/blue-fg}: {yellow-fg}"+e+"{/}"}:null===e?{name:"{blue-fg}"+t+"{/blue-fg}: {cyan-fg}{bold}null{/}"}:{name:"{blue-fg}"+t+"{/blue-fg}: "+e}}}]),t}(),g=function(){function n(){var s=this;_classCallCheck(this,n),this.channel=e.channel("ui"),this.screen=t.screen({smartCSR:!0}),this.logsList=new a,this.logDetails=new o,this.inspecter=new u,this.separator=t.line({bottom:6,orientation:"horizontal"}),this.screen.append(this.logsList.element),this.screen.append(this.logDetails.element),this.screen.append(this.separator),this.screen.append(this.inspecter.element),this.logsList.element.focus(),this.screen.key(["q","C-c"],function(e,t){return process.exit(0)}),this.screen.key(["i"],this.toggleInspecter.bind(this)),this.screen.render(),this.channel.reply("render",function(){return s.screen.render()})}return _createClass(n,[{key:"toggleInspecter",value:function(){this.inspecter.opened?(this.inspecter.close(),this.logsList.focus()):this.inspecter.open(this.logsList.selectedLog),this.screen.render()}}]),n}(),f=function(){function t(n){_classCallCheck(this,t),this.id=r.generate(),this.data=n.data,this.type=n.type,this.status=n.status,this.message=n.message,this.name=n.name,this.date=n.date||Date.now(),this.channel=e.channel("log"),this.children=[],n.parent?(this.depth=n.parent.depth+1,this.parent=n.parent,this.previousLog=n.parent.getLastChild()||n.parent,this.relativeDuration=this.getRelativeDuration(),this.parent.addChild(this)):this.depth=0,this.element=this.channel.request("addLog",this),this.update()}return _createClass(t,[{key:"update",value:function(){this.element&&(this.element.content=this.render(),e.request("ui","render"))}},{key:"render",value:function(){for(var e=""+this.renderState()+this.renderName()+this.renderDate()+this.renderMessage()+this.renderData()+this.renderDuration(),t=0;t<this.depth;t++)e="    "+e;return e}},{key:"renderState",value:function(){return"async"===this.type&&"pending"===this.status?"{cyan-fg}[⌛]{/cyan-fg} ":"async"===this.type&&"resolved"===this.status?"{green-fg}[✔]{/green-fg} ":"async"===this.type&&"rejected"===this.status?"{red-fg}[✘]{/red-fg} ":"success"===this.type?"{green-fg}✔{/green-fg} ":"error"===this.type?"{red-fg}✘{/red-fg} ":"warn"===this.type?"{yellow-fg}❗{/yellow-fg} ":"info"===this.type?"⇢ ":""}},{key:"renderName",value:function(){return 0===this.depth?this.name?"{underline}{bold}"+this.name+"{/bold}{/underline} ":"":"async"===this.type?"resolved"===this.status?"{bold}{green-fg}"+this.name+"{/green-fg}{/bold} (async) ":"rejected"===this.status?"{bold}{red-fg}"+this.name+"{/red-fg}{/bold} (async) ":"{bold}"+this.name+"{/bold} (async) ":"success"===this.type?this.name?"{bold}{green-fg}"+this.name+"{/green-fg}{/bold} ":"":"error"===this.type?this.name?"{bold}{red-fg}"+this.name+"{/red-fg}{/bold} ":"":"warn"===this.type?this.name?"{bold}{yellow-fg}"+this.name+"{/yellow-fg}{/bold} ":"":this.name?"{bold}"+this.name+"{/bold} ":""}},{key:"renderData",value:function(){return 0===this.depth,this.data?Array.isArray(this.data)?this.data.map(this.renderValue.bind(this)).join(" ")+" ":this.renderValue(this.data)+" ":""}},{key:"renderValue",value:function(e){if(Array.isArray(e))return"{cyan-fg}"+s(e,2,8).split('"-pruned-"').join(" ...")+"{/cyan-fg}";if("object"==typeof e)return"{blue-fg}"+s(e,2,8).split('"-pruned-"').join(" ...")+"{/blue-fg}";if("function"==typeof e)return"{red-fg}{bold}[Function]{/bold}{red-fg}";if("number"==typeof e)return"{yellow-fg}"+e+"{/yellow-fg}";if("string"==typeof e){if("success"===this.type)return"{green-fg}"+e+"{/green-fg}";if("error"===this.type)return"{red-fg}"+e+"{/red-fg}";if("warn"===this.type)return"{yellow-fg}"+e+"{/yellow-fg}"}return e}},{key:"renderMessage",value:function(){return this.message?"success"===this.type?"{green-fg}"+this.message+"{/green-fg} ":"error"===this.type?"{red-fg}"+this.message+"{/red-fg} ":"warn"===this.type?"{yellow-fg}"+this.message+"{/yellow-fg} ":this.message+" ":""}},{key:"renderDate",value:function(){return 0===this.depth?"{magenta-fg}("+n(this.date,"dd/mm/yyyy HH:MM:ss.L")+"){/magenta-fg} ":""}},{key:"renderDuration",value:function(){return this.relativeDuration?"{grey-fg}+"+this.relativeDuration+"{/grey-fg} ":""}},{key:"getRelativeDuration",value:function(){return this.humanizeDuration(this.date-this.previousLog.date)}},{key:"humanizeDuration",value:function(e){if(1e3>e)return e+"ms";if(6e4>e){var t=e%1e3;return t=("000"+t).slice(-3),Math.floor(e/1e3)+"."+t+"s"}return Math.floor(e/6e4)+"m "+Math.round(e%6e4/1e3)+"s"}},{key:"addChild",value:function(e){this.children.push(e)}},{key:"getLastChild",value:function(){return this.children[this.children.length-1]}},{key:"getChildren",value:function(e){return e=e||[],e.push.apply(e,this.children),this.children.forEach(function(t){t.getChildren(e)}),e}},{key:"setStatus",value:function(e){this.status=e,this.update()}}]),t}(),y=function(){function e(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return _classCallCheck(this,e),this.name=t,this.children={},this.isAsync=n.isAsync?!0:!1,this.asyncState=this.isAsync?"pending":null,this.type=n.type,this.status=n.status,n.ancestors?(this.ancestors=n.ancestors,this.parent=this.ancestors[this.ancestors.length-1]):(this.ancestors=[],this.isRoot=!0),this.logItem=new f({name:this.name,data:n.data,message:n.message,status:this.status,parent:this.parent?this.parent.logItem:null,type:this.type}),this}return _createClass(e,[{key:"log",value:function(){for(var t=arguments.length,n=Array(t),s=0;t>s;s++)n[s]=arguments[s];return new e(null,{data:n,type:"info",ancestors:this.ancestors.concat(this)}),this}},{key:"warn",value:function(){for(var t=arguments.length,n=Array(t),s=0;t>s;s++)n[s]=arguments[s];return new e(null,{data:n,type:"warn",ancestors:this.ancestors.concat(this)}),this}},{key:"success",value:function(){for(var t=arguments.length,n=Array(t),s=0;t>s;s++)n[s]=arguments[s];return new e(null,{data:n,type:"success",ancestors:this.ancestors.concat(this)}),this}},{key:"error",value:function(){for(var t=arguments.length,n=Array(t),s=0;t>s;s++)n[s]=arguments[s];return new e(null,{data:n,type:"error",ancestors:this.ancestors.concat(this)}),this}},{key:"child",value:function(t){this.children[t]||(this.children[t]=new e(t,{ancestors:this.ancestors.concat(this),type:"child"}));for(var n=arguments.length,s=Array(n>1?n-1:0),r=1;n>r;r++)s[r-1]=arguments[r];if(s.length){var i;(i=this.children[t]).log.apply(i,s)}return this.children[t]}},{key:"async",value:function(t){if(!this.children[t]){this.children[t]=new e(t,{isAsync:!0,type:"async",status:"pending",ancestors:this.ancestors.concat(this)});for(var n=arguments.length,s=Array(n>1?n-1:0),r=1;n>r;r++)s[r-1]=arguments[r];if(s.length){var i;(i=this.children[t]).log.apply(i,s)}return this.children[t]}return this.internalWarn("async("+t+"): child agent has already been defined"),this}},{key:"resolve",value:function(){if(this.isAsync)if("pending"===this.logItem.status){this.logItem.setStatus("resolved");for(var t=new e(this.name,{ancestors:this.ancestors.concat(this),type:"success",message:"resolved"}),n=arguments.length,s=Array(n),r=0;n>r;r++)s[r]=arguments[r];s.length&&t.success.apply(t,s)}else this.internalWarn("Trying to resolve an already "+this.logItem.status+" async agent");else this.internalWarn("Trying to resolve a non async agent");return this}},{key:"reject",value:function(){if(this.isAsync)if("pending"===this.logItem.status){this.logItem.setStatus("rejected");for(var t=new e(this.name,{ancestors:this.ancestors.concat(this),type:"error",message:"rejected"}),n=arguments.length,s=Array(n),r=0;n>r;r++)s[r]=arguments[r];s.length&&t.error.apply(t,s)}else this.internalWarn("Trying to reject an already "+this.logItem.status+" async agent");else this.internalWarn("Trying to reject a non async agent");return this}},{key:"internalWarn",value:function(t){new e(this.name,{ancestors:this.ancestors.concat(this),type:"warn",message:t})}},{key:"getAncestorsNames",value:function(){return this.ancestors.map(function(e){return e.name})}}]),e}(),p=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),s=1;t>s;s++)n[s-1]=arguments[s];return new y(e,{data:n.length?n:void 0,type:"root"})};e.setPromise(null);var m=new g,v={ui:m,agent:p};return v});
//# sourceMappingURL=investigator.min.js.map
