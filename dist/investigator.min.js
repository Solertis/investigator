function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("transceiver"),require("blessed"),require("dateformat"),require("json-prune"),require("path"),require("app-root-path"),require("shortid"),require("stack-trace")):"function"==typeof define&&define.amd?define(["transceiver","blessed","dateformat","json-prune","path","app-root-path","shortid","stack-trace"],t):e.investigator=t(e.transceiver,e.blessed,e.dateFormat,e.prune,e.path,e.appRoot,e.shortid,e.stack_trace)}(this,function(e,t,n,r,s,i,a,o){"use strict";function l(e){if(!(this instanceof u))return new l(e);e=e||{},e.bold=!0;var n=this;this.options=e,this.data={},this.nodeLines=[],this.lineNbr=0,d.call(this,e),e.extended=e.extended||!1,e.keys=e.keys||["space","enter"],e.template=e.template||{},e.template.extend=e.template.extend||" [+]",e.template.retract=e.template.retract||" [-]",e.template.lines=e.template.lines||!1,this.rows=t.list({height:0,top:1,width:0,left:1,selectedFg:"black",selectedBg:"white",keys:!0,tags:!0}),this.rows.key(e.keys,function(){n.nodeLines[this.getItemIndex(this.selected)].extended=!n.nodeLines[this.getItemIndex(this.selected)].extended,n.setData(n.data),n.screen.render(),n.emit("select",n.nodeLines[this.getItemIndex(this.selected)])}),this.append(this.rows)}var h=function(){function n(){var r=this;_classCallCheck(this,n),this.selectedLog=null,this.logs={},this.logsCount=0,this.channel=e.channel("log"),this.autoScroll=!0,this.element=t.list({top:"0",left:"0",bottom:7,tags:!0,keys:!0,mouse:!0,scrollbar:{bg:"magenta"},style:{selected:{fg:"black",bg:"white"}}}),this.element.key(["up","down","s","b"],function(t,n){"s"===n.name?r.autoScroll=!r.autoScroll:"b"===n.name?(r.scrollToBottom(),e.request("ui","render")):r.autoScroll=!1}),this.element.on("select item",function(e,t){r.selectedLog=r.getLogFromElement(e),r.selectedLog&&r.channel.emit("select log",r.selectedLog)}),this.channel.reply({addLog:this.addLog,getSelectedLog:this.getSelectedLog},this)}return _createClass(n,[{key:"addLog",value:function(e){var t=void 0;if(this.logs[e.id]=e,this.logsCount++,e.parent){var n=this.element.getItemIndex(e.parent.element)+e.parent.getChildren().length;this.element.insertItem(n,e.render()),t=this.element.getItem(n)}else t=this.element.add(e.render());return t.logId=e.id,this.autoScroll&&this.scrollToBottom(),1===this.logsCount&&this.channel.emit("select log",e),t}},{key:"getSelectedLog",value:function(){return this.selectedLog}},{key:"scrollToBottom",value:function(){this.element.move(this.logsCount)}},{key:"getLogFromElement",value:function(e){return this.logs[e.logId]}},{key:"focus",value:function(){this.element.focus()}}]),n}(),c=function(){function r(){_classCallCheck(this,r),this.channel=e.channel("log"),this.element=t.box({height:6,left:"0",bottom:0,tags:!0,keys:!0,padding:{left:1,right:1},style:{selected:{fg:"black",bg:"white",border:{fg:"white"},hover:{bg:"green"}}}}),this.channel.on("select log",this.updateLogDetails.bind(this))}return _createClass(r,[{key:"updateLogDetails",value:function(e){this.element.setContent(this.renderType(e)+this.renderId(e)+this.renderDate(e)+this.renderDuration(e)+this.renderData(e))}},{key:"renderType",value:function(e){if("root"===e.type)return"{magenta-fg}{bold}ROOT NODE{/bold}{/magenta-fg}\n";if("success"===e.type)return"{green-fg}✔ {bold}SUCCESS{/bold}{/green-fg}\n";if("error"===e.type)return"{red-fg}✘ {bold}ERROR{/bold}{/red-fg}\n";if("warn"===e.type)return"{yellow-fg}! {bold}WARN{/bold}{/red-fg}\n";if("node"===e.type)return"{grey-fg}{bold}NODE{/bold}{/grey-fg}\n";if("async"===e.type){if("resolved"===e.status)return"{bold}{green-fg}ASYNC NODE{/bold} (RESOLVED ✔){/green-fg}\n";if("rejected"===e.status)return"{bold}{red-fg}ASYNC NODE{/bold} (REJECTED ✘){/red-fg}\n";if("pending"===e.status)return"{cyan-fg}{bold}ASYNC NODE{/bold} (PENDING ⌛){/cyan-fg}\n"}return"info"===e.type?"{white-fg}{bold}INFO{/bold}{/white-fg}\n":""}},{key:"renderId",value:function(e){return"{bold}ID:{/bold} {underline}"+e.id+"{/underline}\n"}},{key:"renderDate",value:function(e){return"{bold}TIME:{/bold} {magenta-fg}"+n(e.date,"dddd, mmmm dS yyyy, HH:MM:ss.L")+"{/magenta-fg}\n"}},{key:"renderDuration",value:function(e){return e.relativeDuration&&e.previousLog?"{bold}DURATION:{/bold} {yellow-fg}"+e.relativeDuration+"{/yellow-fg} (from {underline}"+e.previousLog.id+"{/underline})\n":""}},{key:"renderData",value:function(e){return e.data?"{bold}DATA:{/bold} "+e.renderData()+"\n":""}}]),r}(),u=t.Node,d=t.Box;l.prototype.walk=function(e,t){var n=[];if(e.parent||(e.parent=null),""==t&&e.name&&(this.lineNbr=0,this.nodeLines[this.lineNbr++]=e,n.push(e.name),t=" "),e.depth=t.length-1,e.children&&e.extended){var r=0;"function"==typeof e.children&&(e.childrenContent=e.children(e)),e.childrenContent||(e.childrenContent=e.children);for(var s in e.childrenContent){e.childrenContent[s].name||(e.childrenContent[s].name=s);s=e.childrenContent[s],s.parent=e,s.position=r++,"undefined"==typeof s.extended&&(s.extended=this.options.extended),"function"==typeof s.children?s.childrenContent=s.children(s):s.childrenContent=s.children;var i,a=s.position==Object.keys(s.parent.childrenContent).length-1,o="";i=a?"└":"├",s.childrenContent&&0!=Object.keys(s.childrenContent).length?s.extended?(i+="┬",o=this.options.template.retract):(i+="─",o=this.options.template.extend):i+="─",this.options.template.lines||(i="|-"),n.push(t+i+s.name+o),this.nodeLines[this.lineNbr++]=s;var l;l=a||!this.options.template.lines?t+" ":t+"│",n=n.concat(this.walk(s,l))}}return n},l.prototype.focus=function(){this.rows.focus()},l.prototype.render=function(){this.screen.focused==this.rows&&this.rows.focus(),this.rows.width=this.width-3,this.rows.height=this.height-3,d.prototype.render.call(this)},l.prototype.setData=function(e){var t=[];t=this.walk(e,""),this.data=e,this.rows.setItems(t)},l.prototype.__proto__=d.prototype,l.prototype.type="tree";var g=l,f=function(){function t(){_classCallCheck(this,t),this.channel=e.channel("log"),this.element=g({top:"center",left:"center",width:"90%",height:"75%",hidden:!0,label:"Inspector",tags:!0,border:{type:"line"},style:{fg:"white",border:{fg:"#f0f0f0"}},template:{extend:"{bold}{green-fg} [+]{/}",retract:"{bold}{yellow-fg} [-]{/}",lines:!0}})}return _createClass(t,[{key:"open",value:function(e){e&&(e.data||e.stackTrace)&&(this.opened=!0,this.element.show(),this.element.focus(),this.element.setData(this.prepareData(e)))}},{key:"close",value:function(){this.opened=!1,this.element.hide()}},{key:"prepareData",value:function(e){var t={};return e.data&&(t.data=JSON.parse(r(e.data,{depthDecr:7,replacer:function(e,t,n){return"function"==typeof e?'"Function [pruned]"':Array.isArray(e)?'"Array ('+e.length+') [pruned]"':"object"==typeof e?'"Object [pruned]"':t}}))),e.stackTrace&&(t["stack trace"]=e.stackTrace.map(function(e){var t=s.relative(i.toString(),e.file);return{type:e.type,"function":e["function"],method:e.method,file:t+":{yellow-fg}"+e.line+"{/yellow-fg}:{yellow-fg}"+e.column+"{/yellow-fg}"}})),this.formatData(t)}},{key:"formatData",value:function(e,t){var n=this,r=arguments.length<=2||void 0===arguments[2]?0:arguments[2];if(r++,"object"==typeof e&&null!==e){var s=function(){var s=void 0,i=void 0;if(2===r)s="{yellow-fg}{bold}"+t.toUpperCase()+"{/bold}{/yellow-fg} {magenta-fg}("+e.length+"){/magenta-fg}",i="data"===t;else{var a=Array.isArray(e)?"[Array] {magenta-fg}("+e.length+"){/magenta-fg}":"[Object]";s="{blue-fg}{bold}"+(t?t+" ":"")+"{/bold}"+a+"{/blue-fg}",i=4>r}var o={children:{},name:s,extended:i};return Object.keys(e).forEach(function(t){var s=n.formatData(e[t],t,r);s&&(o.children[t]=s)}),{v:o}}();if("object"==typeof s)return s.v}return"function"==typeof e?{name:"{blue-fg}"+t+"{/blue-fg}: {red-fg}{bold}[Function]{/}"}:"number"==typeof e?{name:"{blue-fg}"+t+"{/blue-fg}: {yellow-fg}"+e+"{/}"}:null===e?{name:"{blue-fg}"+t+"{/blue-fg}: {cyan-fg}{bold}null{/}"}:{name:"{blue-fg}"+t+"{/blue-fg}: "+e}}}]),t}(),y=function(){function n(){var r=this;_classCallCheck(this,n),this.channel=e.channel("ui"),this.screen=t.screen({smartCSR:!0}),this.logsList=new h,this.logDetails=new c,this.inspector=new f,this.separator=t.line({bottom:6,orientation:"horizontal"}),this.screen.append(this.logsList.element),this.screen.append(this.logDetails.element),this.screen.append(this.separator),this.screen.append(this.inspector.element),this.logsList.element.focus(),this.screen.key(["q","C-c"],function(e,t){return process.exit(0)}),this.screen.key(["i"],this.toggleInspector.bind(this)),this.screen.render(),this.channel.reply("render",function(){return r.screen.render()})}return _createClass(n,[{key:"toggleInspector",value:function(){this.inspector.opened?(this.inspector.close(),this.logsList.focus()):this.inspector.open(this.logsList.selectedLog),this.screen.render()}}]),n}(),p=function(){function t(n){var r=n.name,s=n.type,i=n.status,o=n.parent,l=n.data,h=n.message,c=n.stackTrace,u=n.date,d=void 0===u?Date.now():u;_classCallCheck(this,t),this.id=a.generate(),this.name=r,this.type=s,this.status=i,this.data=l,this.message=h,this.stackTrace=c,this.date=d,this.children=[],this.channel=e.channel("log"),o?(this.depth=o.depth+1,this.parent=o,this.previousLog=o.getLastChild()||o,this.relativeDuration=this.getRelativeDuration(),this.parent.addChild(this)):this.depth=0,this.element=this.channel.request("addLog",this),this.update()}return _createClass(t,[{key:"update",value:function(){this.element&&(this.element.content=this.render(),e.request("ui","render"))}},{key:"render",value:function(){for(var e=""+this.renderState()+this.renderName()+this.renderMessage()+this.renderData()+this.renderDate()+this.renderDuration(),t=0;t<this.depth;t++)e="    "+e;return e}},{key:"renderState",value:function(){return"async"===this.type&&"pending"===this.status?"{cyan-fg}[⌛]{/cyan-fg} ":"async"===this.type&&"resolved"===this.status?"{green-fg}[✔]{/green-fg} ":"async"===this.type&&"rejected"===this.status?"{red-fg}[✘]{/red-fg} ":"success"===this.type?"{green-fg}✔{/green-fg} ":"error"===this.type?"{red-fg}✘{/red-fg} ":"warn"===this.type?"{yellow-fg}❗{/yellow-fg} ":"info"===this.type?"⇢ ":""}},{key:"renderName",value:function(){return 0===this.depth?this.name?"{underline}{bold}"+this.name+"{/bold}{/underline} ":"":"async"===this.type?"resolved"===this.status?"{bold}{green-fg}"+this.name+"{/green-fg}{/bold} (async) ":"rejected"===this.status?"{bold}{red-fg}"+this.name+"{/red-fg}{/bold} (async) ":"{bold}"+this.name+"{/bold} (async) ":"success"===this.type?this.name?"{bold}{green-fg}"+this.name+"{/green-fg}{/bold} ":"":"error"===this.type?this.name?"{bold}{red-fg}"+this.name+"{/red-fg}{/bold} ":"":"warn"===this.type?this.name?"{bold}{yellow-fg}"+this.name+"{/yellow-fg}{/bold} ":"":this.name?"{bold}"+this.name+"{/bold} ":""}},{key:"renderData",value:function(){return 0===this.depth,this.data?Array.isArray(this.data)?this.data.map(this.renderValue.bind(this)).join(" ")+" ":this.renderValue(this.data)+" ":""}},{key:"renderValue",value:function(e){if(Array.isArray(e))return"{cyan-fg}"+this.prune(e)+"{/cyan-fg}";if("object"==typeof e)return"{blue-fg}"+this.prune(e)+"{/blue-fg}";if("function"==typeof e)return"{red-fg}{bold}[Function]{/bold}{red-fg}";if("number"==typeof e)return"{yellow-fg}"+e+"{/yellow-fg}";if("string"==typeof e){if("success"===this.type)return"{green-fg}"+e+"{/green-fg}";if("error"===this.type)return"{red-fg}"+e+"{/red-fg}";if("warn"===this.type)return"{yellow-fg}"+e+"{/yellow-fg}"}return e}},{key:"renderMessage",value:function(){return this.message?"success"===this.type?"{green-fg}"+this.message+"{/green-fg} ":"error"===this.type?"{red-fg}"+this.message+"{/red-fg} ":"warn"===this.type?"{yellow-fg}"+this.message+"{/yellow-fg} ":this.message+" ":""}},{key:"renderDate",value:function(){return 0===this.depth?"{magenta-fg}("+n(this.date,"dd/mm/yyyy HH:MM:ss.L")+"){/magenta-fg} ":""}},{key:"renderDuration",value:function(){return this.relativeDuration?"{grey-fg}+"+this.relativeDuration+"{/grey-fg} ":""}},{key:"getRelativeDuration",value:function(){return this.humanizeDuration(this.date-this.previousLog.date)}},{key:"humanizeDuration",value:function(e){if(1e3>e)return e+"ms";if(6e4>e){var t=e%1e3;return t=("000"+t).slice(-3),Math.floor(e/1e3)+"."+t+"s"}return Math.floor(e/6e4)+"m "+Math.round(e%6e4/1e3)+"s"}},{key:"addChild",value:function(e){this.children.push(e)}},{key:"getLastChild",value:function(){return this.children[this.children.length-1]}},{key:"getChildren",value:function(e){return e=e||[],e.push.apply(e,this.children),this.children.forEach(function(t){t.getChildren(e)}),e}},{key:"setStatus",value:function(e){this.status=e,this.update()}},{key:"prune",value:function(e){return r(e,{depthDecr:2,arrayMaxLength:8,prunedString:" [...]"})}}]),t}(),m=function(){function e(t){var n=t.name,r=t.type,s=t.status,i=t.data,a=t.message,l=t.isAsync,h=void 0===l?!1:l,c=t.ancestors;return _classCallCheck(this,e),this.name=n,this.children={},this.isAsync=h,this.asyncState=this.isAsync?"pending":null,this.type=r,this.status=s,c?(this.ancestors=c,this.parent=this.ancestors[this.ancestors.length-1]):(this.ancestors=[],this.isRoot=!0),this.logItem=new p({name:this.name,type:this.type,status:this.status,parent:this.parent?this.parent.logItem:null,data:i,message:a,stackTrace:this.generateStackTrace(o.get())}),this}return _createClass(e,[{key:"log",value:function(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return new e({type:"info",data:n,ancestors:this.ancestors.concat(this)}),this}},{key:"warn",value:function(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return new e({type:"warn",data:n,ancestors:this.ancestors.concat(this)}),this}},{key:"success",value:function(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return new e({type:"success",data:n,ancestors:this.ancestors.concat(this)}),this}},{key:"error",value:function(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return new e({type:"error",data:n,ancestors:this.ancestors.concat(this)}),this}},{key:"child",value:function(t){this.children[t]||(this.children[t]=new e({name:t,type:"node",ancestors:this.ancestors.concat(this)}));for(var n=arguments.length,r=Array(n>1?n-1:0),s=1;n>s;s++)r[s-1]=arguments[s];if(r.length){var i;(i=this.children[t]).log.apply(i,r)}return this.children[t]}},{key:"async",value:function(t){this.children[t]||(this.children[t]=new e({name:t,type:"async",status:"pending",isAsync:!0,ancestors:this.ancestors.concat(this)})),this.children[t].isAsync||this.internalWarn("Child agent {bold}"+t+"{/bold} is defined as a non async agent");for(var n=arguments.length,r=Array(n>1?n-1:0),s=1;n>s;s++)r[s-1]=arguments[s];if(r.length){var i;(i=this.children[t]).log.apply(i,r)}return this.children[t]}},{key:"resolve",value:function(){if(this.isAsync)if("pending"===this.logItem.status){this.logItem.setStatus("resolved");for(var t=new e({name:this.name,type:"success",message:"resolved",ancestors:this.ancestors.concat(this)}),n=arguments.length,r=Array(n),s=0;n>s;s++)r[s]=arguments[s];r.length&&t.success.apply(t,r)}else this.internalWarn("Trying to resolve an already {bold}"+this.logItem.status+"{/bold} async agent");else this.internalWarn("Trying to resolve a non async agent");return this}},{key:"reject",value:function(){if(this.isAsync)if("pending"===this.logItem.status){this.logItem.setStatus("rejected");for(var t=new e({name:this.name,type:"error",message:"rejected",ancestors:this.ancestors.concat(this)}),n=arguments.length,r=Array(n),s=0;n>s;s++)r[s]=arguments[s];r.length&&t.error.apply(t,r)}else this.internalWarn("Trying to reject an already {bold}"+this.logItem.status+"{/bold} async agent");else this.internalWarn("Trying to reject a non async agent");return this}},{key:"internalWarn",value:function(t){new e({name:this.name,type:"warn",message:t,ancestors:this.ancestors.concat(this)})}},{key:"getAncestorsNames",value:function(){return this.ancestors.map(function(e){return e.name})}},{key:"generateStackTrace",value:function(e){for(var t=[],n=0;5>n;n++)t.push({type:e[n].getTypeName(),"function":e[n].getFunctionName(),method:e[n].getMethodName(),file:e[n].getFileName(),line:e[n].getLineNumber(),column:e[n].getColumnNumber()});return t}}]),e}(),v=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];return new m({name:e,type:"root",data:n.length?n:void 0})};e.setPromise(null);var b=new y,k={ui:b,agent:v};return k});
//# sourceMappingURL=investigator.min.js.map
